# Falco Runtime Security Monitoring
---
apiVersion: v1
kind: Namespace
metadata:
  name: falco
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-config
  namespace: falco
data:
  falco.yaml: |
    rules_file:
      - /etc/falco/falco_rules.yaml
      - /etc/falco/falco_rules.local.yaml
      - /etc/falco/k8s_audit_rules.yaml
      - /etc/falco/rules.d

    json_output: true
    json_include_output_property: true

    log_stderr: true
    log_syslog: true
    log_level: info

    priority: debug

    buffered_outputs: false

    outputs:
      rate: 1
      max_burst: 1000

    syslog_output:
      enabled: true

    stdout_output:
      enabled: true

    webserver:
      enabled: true
      listen_port: 8765
      k8s_healthz_endpoint: /healthz
      ssl_enabled: false

    grpc:
      enabled: true
      bind_address: "0.0.0.0:5060"
      threadiness: 8

    grpc_output:
      enabled: true

  falco_rules.local.yaml: |
    # Custom rules for network policy drift detection

    - rule: Unexpected Outbound Connection
      desc: Detect outbound connections not allowed by network policy
      condition: >
        evt.type = connect and
        fd.typechar = 4 and
        fd.net != "127.0.0.0/8" and
        container and
        not k8s.ns.name in (kube-system, monitoring)
      output: >
        Unexpected outbound connection
        (command=%proc.cmdline connection=%fd.name
        container=%container.name namespace=%k8s.ns.name
        pod=%k8s.pod.name)
      priority: WARNING
      tags: [network, policy-drift]

    - rule: Privileged Container Started
      desc: Detect when a privileged container is started
      condition: >
        evt.type = container and
        container.privileged = true
      output: >
        Privileged container started
        (container=%container.name image=%container.image.repository
        namespace=%k8s.ns.name pod=%k8s.pod.name)
      priority: CRITICAL
      tags: [container, cis, security]

    - rule: Shell Spawned in Container
      desc: Detect shell spawned in container
      condition: >
        evt.type = execve and
        evt.dir = < and
        container and
        proc.name in (sh, bash, ash, zsh) and
        proc.pname != entrypoint.sh
      output: >
        Shell spawned in container
        (user=%user.name container=%container.name
        shell=%proc.name parent=%proc.pname
        namespace=%k8s.ns.name pod=%k8s.pod.name)
      priority: WARNING
      tags: [container, shell, mitre_execution]

    - rule: Sensitive File Access
      desc: Detect access to sensitive files
      condition: >
        evt.type in (open, openat) and
        evt.dir = < and
        container and
        fd.name in (/etc/shadow, /etc/passwd, /etc/kubernetes/admin.conf)
      output: >
        Sensitive file access detected
        (user=%user.name file=%fd.name
        container=%container.name namespace=%k8s.ns.name)
      priority: CRITICAL
      tags: [filesystem, confidential]

    - rule: Crypto Mining Activity
      desc: Detect potential crypto mining
      condition: >
        evt.type = execve and
        container and
        (proc.name in (xmrig, minerd, cpuminer) or
         proc.args contains "stratum+tcp://")
      output: >
        Crypto mining detected
        (command=%proc.cmdline container=%container.name
        namespace=%k8s.ns.name pod=%k8s.pod.name)
      priority: CRITICAL
      tags: [cryptomining, mitre_execution]
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
  namespace: falco
  labels:
    app: falco
spec:
  selector:
    matchLabels:
      app: falco
  template:
    metadata:
      labels:
        app: falco
    spec:
      serviceAccountName: falco
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
        - key: node-role.kubernetes.io/control-plane
          effect: NoSchedule
      containers:
        - name: falco
          image: falcosecurity/falco:0.36.2
          securityContext:
            privileged: true
          args:
            - /usr/bin/falco
            - --cri
            - /run/containerd/containerd.sock
            - -K
            - /var/run/secrets/kubernetes.io/serviceaccount/token
            - -k
            - https://kubernetes.default
            - -pk
          volumeMounts:
            - name: config
              mountPath: /etc/falco
            - name: containerd-socket
              mountPath: /run/containerd/containerd.sock
              readOnly: true
            - name: proc
              mountPath: /host/proc
              readOnly: true
            - name: boot
              mountPath: /host/boot
              readOnly: true
            - name: lib-modules
              mountPath: /host/lib/modules
              readOnly: true
            - name: usr
              mountPath: /host/usr
              readOnly: true
            - name: etc
              mountPath: /host/etc
              readOnly: true
          ports:
            - containerPort: 8765
              name: http
            - containerPort: 5060
              name: grpc
          resources:
            limits:
              memory: "512Mi"
              cpu: "500m"
            requests:
              memory: "256Mi"
              cpu: "100m"
      volumes:
        - name: config
          configMap:
            name: falco-config
        - name: containerd-socket
          hostPath:
            path: /run/containerd/containerd.sock
        - name: proc
          hostPath:
            path: /proc
        - name: boot
          hostPath:
            path: /boot
        - name: lib-modules
          hostPath:
            path: /lib/modules
        - name: usr
          hostPath:
            path: /usr
        - name: etc
          hostPath:
            path: /etc
---
apiVersion: v1
kind: Service
metadata:
  name: falco
  namespace: falco
spec:
  selector:
    app: falco
  ports:
    - name: http
      port: 8765
      targetPort: 8765
    - name: grpc
      port: 5060
      targetPort: 5060
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: falco
  namespace: falco
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: falco
rules:
  - apiGroups: [""]
    resources:
      ["nodes", "namespaces", "pods", "services", "endpoints", "events"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: falco
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: falco
subjects:
  - kind: ServiceAccount
    name: falco
    namespace: falco
